# Enumerating AWS Cloud Infreastructure
1. Reconnaissance of Cloud Resources on the Internet
2. Reconnaissance via Cloud Service Provider's API
3. Initial IAM Reconnaissance
4. IAM Resources Enumeration
- [Cyber Kill Chain](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html)

## Reconnaissance of Cloud Resources on the Internet
-  Cloud  Article [NIST](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf)
### Accessing the Lab
- Add the IP address into the /etc/resolv.conf
```bash
nano /etc/resolv.conf
# Generated by NetworkManager
nameserver <AWS IP>
nameserver 1.1.1.1 #system IP
```
- Testing the DNS configuration in Kali using host tool
```powershell
host www.offseclab.io 44.205.254.229 # IP given in AWS lab
host www.offseclab.io # It will give the IP addess
```
### Domain and Subdomain Reconnaissance
- Querying Nameserver Records of offseclab.io Domain
```
host -t ns www.offseclab.io
```
- Getting the Registrar Information of awsdns-00.com Domain
```
whois awsdns-00.com | grep "Registrant Organization"  # aws addess given in the above command
```
- Getting the Public IP address of www.offseclab.io, After adding into /etc/resolv.conf
```
host www.offseclab.io
```
- Getting Details of the Public IP Address of the Website
```
host 52.70.117.69 # IP address provided in the ahove host command
whois 52.70.117.69 | grep "OrgName"
```
-  Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain
```
dnsenum offseclab.io --threads 100
```


### Service-specific Domains
- Access the website in the browser www.offseclab.io
- Go the inspect tab check the Network tab refresh the page
- Observe the images or CDNs are loading from the AWS S3 buckets
- Path like this offseclab-assets-public-axevtewi/sites/www/images/amethyst.png, Try to play with this offseclab-assets-**public**-axevtewi
- Instead of the public try to change private, dev check weather you have access or not.

|AWS|Azure|GCP|
|:-|:-|:-|
|s3.amazonaws.com |wefile.core.windows.netb.core.windows.net |appspot.com |
|awsapps.com |	file.core.windows.net | storage.googleapis.com|
| |blob.core.windows.net | |
| |azurewebsites.net | |
| |	cloudapp.net | |

- Kali Linux has official repository cloud-enum
```
sudo apt install cloud-enum # Installing
cloud_enum --help # Help Menu
```
-  Running Quick Scan Against offseclab-assets-public-axevtewi Bucket Using cloud_enum in AWS
```
cloud_enum -k offseclab-assets-public-axevtewi --quickscan --disable-azure --disable-gcp
```
- Making a Dictionary of Keywords to Search S3 Buckets
```
for key in "public" "private" "dev" "prod" "development" "production"; do echo "offseclab-assets-$key-axevtewi"; done | tee /tmp/keyfile.txt
```
- Running cloud_enum Against The Generated keyfile.txt File
```
cloud_enum -kf /tmp/keyfile.txt -qs --disable-azure --disable-gcp
```

## Reconnaissance via Cloud Service Provider's API



### Preparing the Lab - Configure AWS CLI
- Installing AWS CLI in Kali Linux
```bash
sudo apt update
sudo apt install -y awscli
```
- Configuring Profile and Validating Communication with AWS API
- Details are given in the lab
```bash
aws configure --profile attacker
>AKIAQO...
>cOGzm...
>us-east-1
>json
aws --profile attacker sts get-caller-identity
```

### Publicly Shared Resources
- Listing All Public AMIs Owned by Amazon AWS
```
aws --profile attacker ec2 describe-images --owners amazon --executable-users all
```
- Listing All Public AMIs After Filtering the List Using the Keyword "description"
```
aws --profile attacker ec2 describe-images --executable-users all --filters "Name=description,Values=*Offseclab*"
```
-  Listing All Public AMIs After Filtering the List Using the Keyword "name"
```
aws --profile attacker ec2 describe-images --executable-users all --filters "Name=name,Values=*Offseclab*"
aws --profile attacker ec2 describe-snapshots --filters "Name=description,Values=*offseclab*" # Snapshot description
```



### Obtaining Account IDs from S3 Buckets
- Getting the Name of the Public Bucket with curl
```
curl -s www.offseclab.io | grep -o -P 'offseclab-assets-public-\w{8}'
```
- Listing the Public Bucket as the attacker
```
aws --profile attacker s3 ls offseclab-assets-public-kaykoour
```
- Creating the IAM User "enum" and Generating AccessKeyId and SecretAccessKey for that User
```bash
aws --profile attacker iam create-user --user-name enum
aws --profile attacker iam create-access-key --user-name enum
```
- Configuring AWS CLI with Profile "enum"
- Below values provided in the above commands
```bash
aws configure --profile enum
>AKIAQOMAIGYURE7QCU
>Pxt+Qz9V5baGMF/x0sCNz/SQoSfdq0C+wBzZgwvb
>us-east-1
>json
aws sts get-caller-identity --profile enum
```
- Listing the Private Bucket with the enum User
```
aws --profile enum s3 ls offseclab-assets-private-kaykoour
# An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied  
```
- File policy-s3-read.json.
```bash
{
     "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowResourceAccount",
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetObject"
            ],
            "Resource": "*",
            "Condition": {
                "StringLike": {"s3:ResourceAccount": ["0*"]}
            }
        }
    ]
}
```
- Attaching the s3-read Inline Policy to the enum IAM User
```bash
aws --profile attacker iam put-user-policy --user-name enum --policy-name s3-read --policy-document file://policy-s3-read.json
aws --profile attacker iam list-user-policies --user-name enum
```
- Changing the Condition in the Policy and Testing Again
- Instead of 0 to 1
```bash
kali@kali:~$ aws --profile enum s3 ls offseclab-assets-private-kaykoour

# An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied  

kali@kali:~$ nano policy-s3-read.json

kali@kali:~$ cat -n policy-s3-read.json 
     1  {
     2      "Version": "2012-10-17",
     3      "Statement": [
     4          {
     5              "Sid": "AllowResourceAccount",
     6              "Effect": "Allow",
     7              "Action": [
     8                  "s3:ListBucket",
     9                  "s3:GetObject"
    10              ],
    11              "Resource": "*",
    12              "Condition": {
    13                  "StringLike": {"s3:ResourceAccount": ["1*"]}
    14              }
    15          }
    16      ]
    17  }

kali@kali:~$ aws --profile attacker iam put-user-policy --user-name enum --policy-name s3-read --policy-document file://policy-s3-read.json

kali@kali:~$ aws --profile enum s3 ls offseclab-assets-private-kaykoour
                 #          PRE sites/
```

### Enumerating IAM Users in Other Accounts


Typically, we use the AWS Resource Name (ARN) to specify an IAM identity, as shown below:
```
"Principal": {
  "AWS": ["arn:aws:iam::AccountID:user/user-name"]
}
```
Create S3 bucket with Random number
```
aws --profile attacker s3 mb s3://offseclab-dummy-bucket-$RANDOM-$RANDOM-$RANDOM
#offseclab-dummy-bucket-28967-25641-13328
```
By default, the newly-created bucket is private. Now we are going to define a policy document in which we'll grant read permission only to a specific IAM user in the target account. We can use any text editor 
of our preference to write the policy. We'll use the ARN we crafted earlier to test if the cloudadmin user exists in the account 123456789012.

```bash
nano grant-s3-bucket-read.json
cat grant-s3-bucket-read.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowUserToListBucket",
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::offseclab-dummy-bucket-28967-25641-13328",
            "Principal": {
                "AWS": ["arn:aws:iam::123456789012:user/cloudadmin"]
            },
            "Action": "s3:ListBucket"

        }
    ]
}
```
Checking the Above policy with valid user, If no error returns after running the command, our policy was applied successfully. This also means that the cloudadmin user exists in the target account.
```
aws --profile attacker s3api put-bucket-policy --bucket offseclab-dummy-bucket-28967-25641-13328 --policy file://grant-s3-bucket-read.json
```
Update the policy added the no existed used 

```bash
nano grant-s3-bucket-read-userDoNotExist.json
cat grant-s3-bucket-read-userDoNotExist.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowUserToListBucket",
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::offseclab-dummy-bucket-28967-25641-13328",
            "Principal": {
                "AWS": ["arn:aws:iam::123456789012:user/nonexistant"]
            },
            "Action": "s3:ListBucket"

        }
    ]
}
```
Checking the Above policy with Non valid user, If no error returns after running the command, our policy was applied successfully. This also means that the cloudadmin user exists in the target account.
```bash
aws --profile attacker s3api put-bucket-policy --bucket offseclab-dummy-bucket-28967-25641-13328 --policy file://grant-s3-bucket-read-userDoNotExist.json
# Error An error occurred (MalformedPolicy) when calling the PutBucketPolicy operation: Invalid principal in policy
```
Trying to check existing crafted sample user names
```bash
echo -n "lab_admin
security_auditor
content_creator
student_access
lab_builder
instructor
network_config
monitoring_logging
backup_restore
content_editor" > aws-role-names.txt
```
[Pacu](https://github.com/RhinoSecurityLabs/pacu): The Open Source AWS Exploitation Framework
```bash
sudo apt update
sudo apt install pacu
pacu -h
pacu # It prompt for would like to name this new session?
Pacu(No Keys Set)>import_keys attacker # attacker profile is already set in the AWS CLI
Pacu>ls # it will all the options
Pacu>help iam__enum_roles # Helpoptions
Pacu>run iam__enum_roles --word-list /tmp/role-names.txt --account-id 123456789012 #this is the enum user account ID Identified "lab_admin" 
# Tasked to add the add the "saphire", "ruby", and "amethyst" starting of the in aws-role-names.txt
Pacu>run iam__enum_roles --word-list /tmp/role-names.txt --account-id 123456789012 # Identified amethyst-lab_admin
```
Tasked to find VPC configuration user identified in the above (user:amethyst-lab_admin) it will provide Session ID, Session Key, Session token export these details

```bash
# First export these 3 details of the user-amethyst-lab_admin identified in the above command
export AWS_ACCESS_KEY_ID=ASIAT7HC76KDHAY56JLG
export AWS_SECRET_ACCESS_KEY=KlS9b8fZMj72nCfTsdhcwex/7mrH1PGdnLB1ZCBi
export AWS_SESSION_TOKEN=FwoGZXI---TRUNKATED--SfTktvIrSwwA==
#Run this command identify the VPC configuration for user-amethyst-lab_admin
aws ec2 describe-vpcs --region us-east-1
```
