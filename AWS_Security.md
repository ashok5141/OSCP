# Enumerating AWS Cloud Infreastructure
1. Reconnaissance of Cloud Resources on the Internet
2. Reconnaissance via Cloud Service Provider's API
3. Initial IAM Reconnaissance
4. IAM Resources Enumeration
- [Cyber Kill Chain](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html)

## Reconnaissance of Cloud Resources on the Internet
-  Cloud  Article [NIST](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf)
### Accessing the Lab
- Add the IP address into the /etc/resolv.conf
```bash
nano /etc/resolv.conf
# Generated by NetworkManager
nameserver <AWS IP>
nameserver 1.1.1.1 #system IP
```
- Testing the DNS configuration in Kali using host tool
```powershell
host www.offseclab.io 44.205.254.229 # IP given in AWS lab
host www.offseclab.io # It will give the IP addess
```
### Domain and Subdomain Reconnaissance
- Querying Nameserver Records of offseclab.io Domain
```
host -t ns www.offseclab.io
```
- Getting the Registrar Information of awsdns-00.com Domain
```
whois awsdns-00.com | grep "Registrant Organization"  # aws addess given in the above command
```
- Getting the Public IP address of www.offseclab.io, After adding into /etc/resolv.conf
```
host www.offseclab.io
```
- Getting Details of the Public IP Address of the Website
```
host 52.70.117.69 # IP address provided in the ahove host command
whois 52.70.117.69 | grep "OrgName"
```
-  Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain
```
dnsenum offseclab.io --threads 100
```


### Service-specific Domains
- Access the website in the browser www.offseclab.io
- Go the inspect tab check the Network tab refresh the page
- Observe the images or CDNs are loading from the AWS S3 buckets
- Path like this offseclab-assets-public-axevtewi/sites/www/images/amethyst.png, Try to play with this offseclab-assets-**public**-axevtewi
- Instead of the public try to change private, dev check weather you have access or not.

|AWS|Azure|GCP|
|:-|:-|:-|
|s3.amazonaws.com |wefile.core.windows.netb.core.windows.net |appspot.com |
|awsapps.com |	file.core.windows.net | storage.googleapis.com|
| |blob.core.windows.net | |
| |azurewebsites.net | |
| |	cloudapp.net | |

- Kali Linux has official repository cloud-enum
```
sudo apt install cloud-enum # Installing
cloud_enum --help # Help Menu
```
-  Running Quick Scan Against offseclab-assets-public-axevtewi Bucket Using cloud_enum in AWS
```
cloud_enum -k offseclab-assets-public-axevtewi --quickscan --disable-azure --disable-gcp
```
- Making a Dictionary of Keywords to Search S3 Buckets
```
for key in "public" "private" "dev" "prod" "development" "production"; do echo "offseclab-assets-$key-axevtewi"; done | tee /tmp/keyfile.txt
```
- Running cloud_enum Against The Generated keyfile.txt File
```
cloud_enum -kf /tmp/keyfile.txt -qs --disable-azure --disable-gcp
```

## Reconnaissance via Cloud Service Provider's API



### Preparing the Lab - Configure AWS CLI
- Installing AWS CLI in Kali Linux
```bash
sudo apt update
sudo apt install -y awscli
```
- Configuring Profile and Validating Communication with AWS API
- Details are given in the lab
```bash
aws configure --profile attacker
>AKIAQO...
>cOGzm...
>us-east-1
>json
aws --profile attacker sts get-caller-identity
```

### Publicly Shared Resources
- Listing All Public AMIs Owned by Amazon AWS
```
aws --profile attacker ec2 describe-images --owners amazon --executable-users all
```
- Listing All Public AMIs After Filtering the List Using the Keyword "description"
```
aws --profile attacker ec2 describe-images --executable-users all --filters "Name=description,Values=*Offseclab*"
```
-  Listing All Public AMIs After Filtering the List Using the Keyword "name"
```
aws --profile attacker ec2 describe-images --executable-users all --filters "Name=name,Values=*Offseclab*"
aws --profile attacker ec2 describe-snapshots --filters "Name=description,Values=*offseclab*" # Snapshot description
```



### Obtaining Account IDs from S3 Buckets
- Getting the Name of the Public Bucket with curl
```
curl -s www.offseclab.io | grep -o -P 'offseclab-assets-public-\w{8}'
```
- Listing the Public Bucket as the attacker
```
aws --profile attacker s3 ls offseclab-assets-public-kaykoour
```
- Creating the IAM User "enum" and Generating AccessKeyId and SecretAccessKey for that User
```bash
aws --profile attacker iam create-user --user-name enum
aws --profile attacker iam create-access-key --user-name enum
```
- Configuring AWS CLI with Profile "enum"
- Below values provided in the above commands
```bash
aws configure --profile enum
>AKIAQOMAIGYURE7QCU
>Pxt+Qz9V5baGMF/x0sCNz/SQoSfdq0C+wBzZgwvb
>us-east-1
>json
aws sts get-caller-identity --profile enum
```
- Listing the Private Bucket with the enum User
```
aws --profile enum s3 ls offseclab-assets-private-kaykoour
# An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied  
```
- File policy-s3-read.json.
```bash
{
     "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowResourceAccount",
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetObject"
            ],
            "Resource": "*",
            "Condition": {
                "StringLike": {"s3:ResourceAccount": ["0*"]}
            }
        }
    ]
}
```
- Attaching the s3-read Inline Policy to the enum IAM User
```bash
aws --profile attacker iam put-user-policy --user-name enum --policy-name s3-read --policy-document file://policy-s3-read.json
aws --profile attacker iam list-user-policies --user-name enum
```
- Changing the Condition in the Policy and Testing Again
- Instead of 0 to 1
```bash
kali@kali:~$ aws --profile enum s3 ls offseclab-assets-private-kaykoour

# An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied  

kali@kali:~$ nano policy-s3-read.json

kali@kali:~$ cat -n policy-s3-read.json 
     1  {
     2      "Version": "2012-10-17",
     3      "Statement": [
     4          {
     5              "Sid": "AllowResourceAccount",
     6              "Effect": "Allow",
     7              "Action": [
     8                  "s3:ListBucket",
     9                  "s3:GetObject"
    10              ],
    11              "Resource": "*",
    12              "Condition": {
    13                  "StringLike": {"s3:ResourceAccount": ["1*"]}
    14              }
    15          }
    16      ]
    17  }

kali@kali:~$ aws --profile attacker iam put-user-policy --user-name enum --policy-name s3-read --policy-document file://policy-s3-read.json

kali@kali:~$ aws --profile enum s3 ls offseclab-assets-private-kaykoour
                 #          PRE sites/
```

### Enumerating IAM Users in Other Accounts


Typically, we use the AWS Resource Name (ARN) to specify an IAM identity, as shown below:
```
"Principal": {
  "AWS": ["arn:aws:iam::AccountID:user/user-name"]
}
```
Create S3 bucket with Random number
```
aws --profile attacker s3 mb s3://offseclab-dummy-bucket-$RANDOM-$RANDOM-$RANDOM
#offseclab-dummy-bucket-28967-25641-13328
```
By default, the newly-created bucket is private. Now we are going to define a policy document in which we'll grant read permission only to a specific IAM user in the target account. We can use any text editor 
of our preference to write the policy. We'll use the ARN we crafted earlier to test if the cloudadmin user exists in the account 123456789012.

```bash
nano grant-s3-bucket-read.json
cat grant-s3-bucket-read.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowUserToListBucket",
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::offseclab-dummy-bucket-28967-25641-13328",
            "Principal": {
                "AWS": ["arn:aws:iam::123456789012:user/cloudadmin"]
            },
            "Action": "s3:ListBucket"

        }
    ]
}
```
Checking the Above policy with valid user, If no error returns after running the command, our policy was applied successfully. This also means that the cloudadmin user exists in the target account.
```
aws --profile attacker s3api put-bucket-policy --bucket offseclab-dummy-bucket-28967-25641-13328 --policy file://grant-s3-bucket-read.json
```
Update the policy added the no existed used 

```bash
nano grant-s3-bucket-read-userDoNotExist.json
cat grant-s3-bucket-read-userDoNotExist.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowUserToListBucket",
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::offseclab-dummy-bucket-28967-25641-13328",
            "Principal": {
                "AWS": ["arn:aws:iam::123456789012:user/nonexistant"]
            },
            "Action": "s3:ListBucket"

        }
    ]
}
```
Checking the Above policy with Non valid user, If no error returns after running the command, our policy was applied successfully. This also means that the cloudadmin user exists in the target account.
```bash
aws --profile attacker s3api put-bucket-policy --bucket offseclab-dummy-bucket-28967-25641-13328 --policy file://grant-s3-bucket-read-userDoNotExist.json
# Error An error occurred (MalformedPolicy) when calling the PutBucketPolicy operation: Invalid principal in policy
```
Trying to check existing crafted sample user names
```bash
echo -n "lab_admin
security_auditor
content_creator
student_access
lab_builder
instructor
network_config
monitoring_logging
backup_restore
content_editor" > aws-role-names.txt
```
[Pacu](https://github.com/RhinoSecurityLabs/pacu): The Open Source AWS Exploitation Framework
```bash
sudo apt update
sudo apt install pacu
pacu -h
pacu # It prompt for would like to name this new session?
Pacu(No Keys Set)>import_keys attacker # attacker profile is already set in the AWS CLI
Pacu>ls # it will all the options
Pacu>help iam__enum_roles # Helpoptions
Pacu>run iam__enum_roles --word-list /tmp/role-names.txt --account-id 123456789012 #this is the enum user account ID Identified "lab_admin" 
# Tasked to add the add the "saphire", "ruby", and "amethyst" starting of the in aws-role-names.txt
Pacu>run iam__enum_roles --word-list /tmp/role-names.txt --account-id 123456789012 # Identified amethyst-lab_admin
```
Tasked to find VPC configuration user identified in the above (user:amethyst-lab_admin) it will provide Session ID, Session Key, Session token export these details

```bash
# First export these 3 details of the user-amethyst-lab_admin identified in the above command
export AWS_ACCESS_KEY_ID=ASIAT7HC76KDHAY56JLG
export AWS_SECRET_ACCESS_KEY=KlS9b8fZMj72nCfTsdhcwex/7mrH1PGdnLB1ZCBi
export AWS_SESSION_TOKEN=FwoGZXI---TRUNKATED--SfTktvIrSwwA==
#Run this command identify the VPC configuration for user-amethyst-lab_admin
aws ec2 describe-vpcs --region us-east-1
```


## Initial IAM Reconnaissance
1. Examining Compromised Credentials
2. Scoping IAM permissions
- At this stage, we won't begin enumerating resources. Instead, we'll focus on gathering initial information from the compromised credentials, including understanding the scope of access within the AWS environment. We'll explore various techniques for this, some stealthy and others less so.

### Accessing the Lab
> After deploying the lab we'll receive credentials to interact with AWS as three different users.
1. The **target user** will simulate the compromised access to the cloud environment. This is the user we'll use most often while learning techniques to get information from this initial access.
2. The **challenge user** is an auxiliary user with very limited access that we'll use to test concepts and execute additional tasks, validating our newly learned skills.
3. The **monitor user** will simulate an operator with access to Cloudtrail, the AWS logging service.
- For the moment let's start the lab deployment and take note of this information. We can organize the data as follows:
- Credentials access as the target user.
     - Target ACCESS KEY ID
     - Target SECRET ACCESS KEY
- Credentials access as the challenge user.
     - Challenge ACCESS KEY ID
     - Challenge SECRET ACCESS KEY
- Credentials to access as the monitor user.
     - Management Console login URL
     - Username
     - Password

### Examining Compromised Credentials
- configure the target user profile, details given in the lab
```powershell
aws configure --profile target
aws --profile target aws sts get-caller-identity
# Account ID - 619071316869
```
- configure the challenge user profile, details given in the lab
```powershell
aws configure --profile challenge
aws --profile challenge sts get-caller-identity
# Account ID - 619071316869 same as target
```
- Getting the account ID from access keys with the get-access-key-info command
```
aws --profile challenge sts get-access-key-info --access-key-id AKIAQOMAIGYUVEHJ7--M
```
- Penetration testers can also use the get-access-key-info subcommand to determine whether or not a compromised credential is inside the scope of the assessment.
- Another stealthy approach is to abuse error messages that aren't logged by default in the Cloudtrail event history. For example, let's try invoking a nonexistent Lambda function using the compromised credentials.
```bash
aws --profile target lambda invoke --function-name arn:aws:lambda:us-east-1:619071316869:function:nonexistent-function outfile
#An error occurred (AccessDeniedException) when calling the Invoke operation: User: arn:aws:iam::619071316869:user/support/clouddesk-plove is not authorized to perform: lambda:InvokeFunction on resource: arn:aws:lambda:us-east-1:619071316869:function:nonexistent-function because no identity-based policy allows the lambda:InvokeFunction action
```
#### CloudTrail
- Check the logs in CloudTrail login to account credentials provided in lab for the region [us-east-1](https://us-east-1.console.aws.amazon.com/cloudtrail/home?region=us-east-1#/events?EventName=GetCallerIdentity&CustomTime=1800000)
- In the search CloudTrail -> Left Menu -> Event History tab 

- Executing an API request to another region
- Check the cloud trail logs on [us-east-2](https://us-east-2.console.aws.amazon.com/cloudtrail/home?region=us-east-2#/events?EventName=GetCallerIdentity&CustomTime=1800000)
```
aws --profile target sts get-caller-identity --region us-east-2
```


### Scoping IAM permissions
- All cloud providers implement some kind of authentication and authorization mechanisms to ensure that users can only interact with the provider's API within their designated permissions and cannot act on behalf of other users or accounts. All these mechanisms are commonly grouped under the umbrella term Identity and Access Management (IAM).

- The Principle of Least Privilege (PoLP) is generally followed as a best practice for any cloud deployment. This principle suggests granting users only the permissions they need to perform their tasks, and nothing more. This will reduce actions that can be performed and limit potential attack vectors that an attacker can exploit from a compromised account. However, overly-permissive identities are still a common finding and the major cause of breaches in cloud environments.

- Continuing in the lab, we'll again take on the role of an attacker to determine the extent of permissions associated with the compromised credentials in the target environment.
```bash
aws --profile target aws sts get-caller-identity
# "Arn": "arn:aws:iam::619071316869:user/support/clouddesk-plove"
```
- This suggests the purpose of the user and what permissions they likely have. For example, "clouddesk" and "support" may tell us that the user has some IAM-related privileges to grant access or reset credentials. This type of hypothesis is helpful as it's extra information we've gained while maintaining a low profile.

- We can list inline policies and managed policies associated with IAM user
```bash
aws --profile target iam list-user-policies --user-name clouddesk-plove # Nothing returned
aws --profile target iam list-attached-user-policies --user-name clouddesk-plove
# "PolicyName": "deny_challenges_access",
#"PolicyArn": "arn:aws:iam::619071316869:policy/deny_challenges_access"
```
- Listing the groups to which the user belongs.
```bash
aws --profile target iam list-groups-for-user --user-name clouddesk-plove
# Output
{
    "Groups": [
        {
            "Path": "/support/",
            "GroupName": "support",
            "GroupId": "AGPAZAI4GUOCZBYDLSXUW",
            "Arn": "arn:aws:iam::619071316869:group/support/support",
            "CreateDate": "2024-11-27T02:58:08+00:00"
        }
    ]
}
```
- Now we have discovered that IAM user belong to the one group that is Support group
- Now we will check for policies associated with the support group, we'll search for inline and managed policies in a search similar to one we ran previously.
```bash
aws --profile target iam list-group-policies --group-name support # Nothing returned
aws --profile target iam list-attached-group-policies --group-name support
# "PolicyName": "SupportUser",
# "PolicyArn": "arn:aws:iam::aws:policy/job-function/SupportUser"
```
- Listing a policy version
```bash
aws --profile target iam list-policy-versions --policy-arn "arn:aws:iam::aws:policy/job-function/SupportUser"
# Consider most recent version  "VersionId": "v8"
```
- Listing a policy definition by its version
- Some of these elements define a specific action. For example, acm:DescribeCertificate defines the DescribeCertificate action for the AWS Certificate Manager service. Other elements use the "*" wildcard to describe any action that starts with read-only keywords such as Get, Describe and, List. These actions are allowed to run against any resource of the given services as stated in the "Resource": "*" line.
```bash
aws --profile target iam get-policy-version --policy-arn arn:aws:iam::aws:policy/job-function/SupportUser --version-id v8
# "Effect": "Allow",
# "Resource": "*"
```
#### Task
- Use the challenge Profile in AWS CLI to scope the level of actions allowed to run in the EC2 service. Run the permitted actions to list or describe Resources. You will find a Tag Key named proof in one of the resources you can list. Enter the value of the Tag Key.
- **Hint** We need to focus on actions that list/describe resources. We can also use tools like pacu to find allowed actions by brute force.
```bash
aws --profile challenge ec2 describe-vpcs
aws --profile challenge ec2 describe-vpcs --query "Vpcs[].Tags[?Key=='proof']"
```

## IAM Resources Enumeration
1. Choosing Between a Manual or Automated Enumeration Approach
2. Enumerating IAM Resources
3. Processing API Response data with JMESPath
4. Running Automated Enumeration with Pacu
5. Extracting Insights from Enumeration Data

### Choosing Between a Manual or Automated Enumeration Approach
- Several commercial and open-source tools have been developed to perform information gathering against cloud-based infrastructures. Some of these tools are tailored towards specific cloud providers, while others support multiple providers. Some are GUI-based and some run from the command line. Some are automated and some require manual intervention.
> Most tools generate significant log events and may trigger monitoring systems. This may not be a significant consideration when performing a red team assessment or a penetration test in which stealth is not a requirement, but when stealth is a factor, we must test our tools to determine the potential impact prior to an engagement.

### Enumerating IAM Resources
- As we begin to enumerate IAM resources, we'll start our scenario in possession of an already-compromised account. Let's summarize what we have already learned from the compromised credentials.

| Resource Type | Name | ARN |
|:-|:-|:-|
|IAM::User |clouddesk-plove |arn:aws:iam::123456789012:user/support/clouddesk-plove |
|IAM::Group |Support |arn:aws:iam::123456789012:group/support/support |
|IAM::Policy |SupportUser |arn:aws:iam::aws:policy/job-function/SupportUser |

> AWS custom-managed policies allow users to define a set of permissions that can be reused and associated with multiple IAM users, groups, or roles. While these policies offer flexibility for IAM management, there is an inherent security risk if they are crafted to be overly permissive.
- SupportUser is an AWS custom-managed policy that grants permissions to troubleshoot and resolve issues in an AWS account. This policy grants read-only access to explore several services.
- Again started lab configuring above [steps](https://github.com/ashok5141/OSCP/blob/main/AWS_Security.md#examining-compromised-credentials)
- Let's check what actions this policy grants to enumerate IAM resources. To do this we'll run iam get-policy-version to show the policy definition. We'll pipe the output to grep to filter and display only the lines that contain the string iam.
```bash
aws --profile target iam get-policy-version --policy-arn arn:aws:iam::aws:policy/job-function/SupportUser --version-id v8 | grep "iam"
```
- With this policy, we can run any iam subcommand that starts with get and list and two other specific actions. To list the available subcommands in AWS CLI we can use the help option.
- Let's run aws iam help to display a description of the command usage including a list of all available subcommands. We'll also add | grep -E "list-|get-|generate-" to filter all the lines that include the words "list-", "get-" and "generate-".
```
aws --profile target iam help | grep -E "list-|get-|generate-"
```
- IAM is a critical component of AWS that manages all actions related to the authentication and authorization of identities. Having this level of access, even through it's read-only access, is a big deal.
We won't cover the list of subcommands in this lab. However, we could learn about any of them running `aws iam command help`. This will show details about the subcommands and their basic usage, including the required and optional parameters.
- Let's start by getting a summary of the IAM-related information in the account. We'll run `aws I am get-account-summaary` with no additional arguments and put it into the json format
```bash
aws --profile target iam get-account-summary | tee account-summary.json
{
  "SummaryMap": {
    "GroupPolicySizeQuota": 5120,
    "InstanceProfilesQuota": 1000,
    "Policies": 8,
    "GroupsPerUserQuota": 10,
    "InstanceProfiles": 0,
    "AttachedPoliciesPerUserQuota": 10,
    "Users": 18,
    "PoliciesQuota": 1500,
    "Providers": 1,
    "AccountMFAEnabled": 0,
    "AccessKeysPerUserQuota": 2,
    "AssumeRolePolicySizeQuota": 2048,
    "PolicyVersionsInUseQuota": 10000,
    "GlobalEndpointTokenVersion": 1,
    "VersionsPerPolicyQuota": 5,
    "AttachedPoliciesPerGroupQuota": 10,
    "PolicySizeQuota": 6144,
    "Groups": 8,
    "AccountSigningCertificatesPresent": 0,
    "UsersQuota": 5000,
    "ServerCertificatesQuota": 20,
    "MFADevices": 0,
    "UserPolicySizeQuota": 2048,
    "PolicyVersionsInUse": 28,
    "ServerCertificates": 0,
    "Roles": 21,
    "RolesQuota": 1000,
    "SigningCertificatesPerUserQuota": 2,
    "MFADevicesInUse": 0,
    "RolePolicySizeQuota": 10240,
    "AttachedPoliciesPerRoleQuota": 10,
    "AccountAccessKeysPresent": 0,
    "AccountPasswordPresent": 1,
    "GroupsQuota": 300
  }
}
```
- The output shows some information that is more relevant for administrators such as resource quotas, but it also shows insights about the number of IAM resources created in the account such as Users, Roles, Groups and Policies.
- Let's continue enumerating all IAM identities list-users, list-groups and list-roles subcommand
```bash
aws --profile target iam list-users | tee users.json
aws --profile target iam list-groups | tee groups.json
aws --profile target iam list-roles | tee roles.json
```
- We can list all managed policies with list-policies. We'll use --scope Local to display only the Customer Managed Policies and omit the AWS Managed Policies, and we'll use --only-attached to list the policies that are attached to an IAM identity.
```bash
aws --profile target iam list-policies --scope Local --only-attached | tee Policies.json
```
- Next, to get the inline policies for every identity associated with the compromised credentials, we could run the following subcommand:
     - list-user-policies
     - get-user-policy
     - list-group-policies
     - get-group-policy
     - list-role-policies
     - get-role-policy
- Similarly, we can check for all managed policies with the following subcommand:
     - list-attached-user-policies
     - list-attached-group-policies
     - list-attached-role-policies
> In order to execute get-account-authorization-details, the account running the command must have the GetAccountAuthorizationDetails permission attached to its policy. While it's not common to find this permission exclusively on a policy, it is included when a wildcard is used for all get permissions (iam:Get*) which is common.
```bash
aws --profile target iam get-account-authorization-details --filter User Group LocalManagedPolicy Role | tee account-authorization-details.json
```
- Let's check something curious about the user authorization details we discovered.
- User clouddesk-plove IAM user is associated with a policy that denies access to certain resources.
```bash
aws --profile target iam list-attached-user-policies --user-name clouddesk-plove
{
    "AttachedPolicies": [
        {
            "PolicyName": "deny_challenges_access",
            "PolicyArn": "arn:aws:iam::238741419615:policy/deny_challenges_access"
        }
    ]
}
```
- We identified one managed policy (named deny_challenges_access) associated with the user. To understand the policy's function, we need to read its policy document. Let's take the ARN of policy and attempt to list version to gain further insights.
```bash
aws --profile target iam list-policy-versions --policy-arn arn:aws:iam::238741419615:policy/deny_challenges_access
# An error occurred (AccessDenied) when calling the ListPolicyVersions operation: User: arn:aws:iam::238741419615:user/support/clouddesk-plove is not authorized to perform: iam:ListPolicyVersions on resource: policy arn:aws:iam::238741419615:policy/deny_challenges_access with an explicit deny in an identity-based policy
```
- This error message, indicating that the operation is "explicitly denied" suggests that the administrator restricted this user's access to certain resources.
- Let's check interesting  **get-account-authorization-details -- filter LocalManagedPolicy** to retrive all the custom managed policies of the account and browse the list until we find the details of the **deny_challenges_access** policy.
```bash
aws --profile target iam get-account-authorization-details --filter LocalManagedPolicy
```
- FInd users from the group
```bash
aws --profile target iam get-group --group-name ruby_dev
```

### Processing API Response data with JMESPath
- As previously mentioned, we have been using the aws client which produces JSON output by default. In this section, we will process the JSON output with [JMESPath](https://jmespath.org/) .
- In this section, we'll learn some basic querying using JMESPath by running some examples against the output of the iam **get-account-authorization-details** subcommand.

```bash
aws --profile target iam get-account-authorization-details --filter User
{
    "UserDetailList": [
        {
            "Path": "/admin/",
            "UserName": "admin-alice",
            "UserId": "AIDATPFQY6ZP6V2CMANTY",
            "Arn": "arn:aws:iam::238741419615:user/admin/admin-alice",
            "CreateDate": "2024-12-04T18:12:11+00:00",
            "GroupList": [
                "amethyst_admin",
                "admin"
            ],
            "AttachedManagedPolicies": [],
            "Tags": [
                {
                    "Key": "Project",
                    "Value": "amethyst"
                },
                {
                    "Key": "ce1df3c0-33f8-4eac-bb8a-356a133b3ac0",
                    "Value": "ce1df3c0-33f8-4eac-bb8a-356a133b3ac0"
                }
            ]
        }
  -------Truncated----
}
```
- Now, Let's query only for the UserName keys for all the objects. This is a perfect opportunity to use a "UserDetailList[].UserName"
```bash
aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[].UserName"
[
    "admin-alice",
    "admin-cbarton",
    "admin-srogers",
    "admin-tstark",
    "challenge",
    "clouddesk-bob",
    "clouddesk-fruiz",
    "clouddesk-plove",
    "dev-ballen",
    "dev-csandiego",
    "dev-ddory",
    "dev-jreyes",
    "dev-mmurdock",
    "dev-mwindu",
    "dev-prince",
    "dev-rboggs",
    "dev-shedgehog",
    "monitoring"
]
```
- Filter some specific fields
```bash
aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[0].UserName,Path,GroupList]"
[
    "admin-alice",
    "/admin/",
    [
        "amethyst_admin",
        "admin"
    ]
]
```
- With parameter names
```bash
aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[0].{Name: UserName,Path: Path,Groups: GroupList}"
{
    "Name": "admin-alice",
    "Path": "/admin/",
    "Groups": [
        "amethyst_admin",
        "admin"
    ]
}
```
- For example, let's list all the IAM Users whose usernames contain the word admin. We would use the UserDetailList[?contains(UserName, 'admin')] expression. Let's run that now.
```bash
aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[?contains(UserName, 'admin')].{Name: UserName}" 
[
    {
        "Name": "admin-alice"
    },
    {
        "Name": "admin-cbarton"
    },
    {
        "Name": "admin-srogers"
    },
    {
        "Name": "admin-tstark"
    }
]
```
- If the two expressions are written separately the expressions would be UserDetailList[?Path=='/admin/'].UserName and GroupDetailList[?Path=='/admin/'].GroupName. Let's build a JSON object with the desired elements. The Listing below shows the JSON object. Notice that we must use the --filter User Group argument to also obtain the Group objects.
```powershell
aws --profile target iam get-account-authorization-details --filter User Group --query "{Users: UserDetailList[?Path=='/admin/'].UserName, Groups: GroupDetailList[?Path=='/admin/'].{Name: GroupName}}"
{
    "Users": [
        "admin-alice"
    ],
    "Groups": [
        {
            "Name": "admin"
        }
    ]
}
```

#### Task
- What JMESPath expression will filter and display all users that contain the word "admin" in the Username and the Path fields? (Write only the JMESPath expression starting with "?". Use the contains function for both conditions. Example: ?contains(Path,'admin') ... )
```powershell
aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[?contains(UserName,'admin') && contains(Path,'admin')].{Name: UserName}"
[
    {
        "Name": "admin-alice"
    }
]
```

### Running Automated Enumeration with Pacu
- In this section, we'll explore some of pacu's enumeration modules as a case study for automated AWS enumeration. The goal of automation is to not only to streamline our work but more importantly to help us better understand the process and even build our own tools and workflows
```powershell
sudo apt update
sudo apt install pacu
```
- Now let's run help iam__enum_users_roles_policies_groups to learn about this module.
```powershell
help iam__enum_users_roles_policies_groups
```
- This module works similarly to the get-account-authorization-details subcommand
```powershell
run iam__enum_users_roles_policies_groups
[iam__enum_users_roles_policies_groups] MODULE SUMMARY:
  18 Users Enumerated
  21 Roles Enumerated
  8 Policies Enumerated
  8 Groups Enumerated
  IAM resources saved in Pacu database.
```
- To display a list of services that have collected data in the current session we'll run the services command. Then we can run the data <service> command to display all data for the specified service in the session.
```powershell
services
data IAM
```
### Extracting Insights from Enumeration Data
- Let's start with an obvious path. We'll analyze the admin-alice IAM user's data from the output of the get-account-authorization-details IAM subcommand.
```powershell
aws --profile target iam get-account-authorization-details --filter User Group --query "UserDetailList[?UserName=='admin-alice']"
```
> Attribute-Based Access Control (ABAC) is an authorization strategy in which a subject's permission to perform a set of operations is determined by evaluating attributes associated with that subject. Tags are commonly used as attributes to implement ABAC in public cloud environments.
```powershell
aws --profile target iam get-account-authorization-details --filter User Group --query "GroupDetailList[?GroupName=='admin']"
aws --profile target iam get-account-authorization-details --filter User Group --query "GroupDetailList[?GroupName=='amethyst_admin']"
```
- Let's **get-account-authorization-details** IAM subcommand to get this information.
```powershell
aws --profile target iam get-account-authorization-details --filter LocalManagedPolicy --query "Policies[?PolicyName=='amethyst_admin']"
```
